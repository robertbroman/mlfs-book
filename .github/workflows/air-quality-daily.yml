name: air-quality-daily

on:
  workflow_dispatch:
  schedule:
    - cron: '11 6 * * *'

jobs:
  schedule_pipelines:
    runs-on: ubuntu-latest

    permissions:
      pages: write
      contents: write

    steps:
      - name: checkout repo content
        uses: actions/checkout@v4

      - name: setup python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: install python packages
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: execute python workflows from bash script (multiple locations)
        env:
          HOPSWORKS_API_KEY: ${{ secrets.HOPSWORKS_API_KEY }}
        run: |
          set -euo pipefail
          LOC_JSON="notebooks/airquality/locations.json"
          if [ ! -f "$LOC_JSON" ]; then
            echo "Locations file not found: $LOC_JSON"
            exit 1
          fi

          LEN=$(jq length "$LOC_JSON")
          if [ "$LEN" -eq 0 ]; then
            echo "No locations in $LOC_JSON"
            exit 1
          fi

          echo "Found $LEN locations. Running for each location..."

          for IDX in $(seq 0 $((LEN - 1))); do
            echo "=== LOCATION INDEX: $IDX ==="
            LOC=$(jq -c ".[$IDX]" "$LOC_JSON")
            CITY=$(echo "$LOC" | jq -r '.city // empty')
            STREET=$(echo "$LOC" | jq -r '.street // empty')
            COUNTRY=$(echo "$LOC" | jq -r '.country // empty')
            AQICN_URL=$(echo "$LOC" | jq -r '.aqicn_url // empty')

            echo "Running notebooks for: index=$IDX aqicn_url=$AQICN_URL city=$CITY street=$STREET country=$COUNTRY"

            export CITY STREET COUNTRY AQICN_URL LOCATION_INDEX=$IDX

            ipython notebooks/airquality/2_air_quality_feature_pipeline.ipynb || {
              echo "Feature pipeline FAILED for $LOCATION_ID (index $IDX)"; 
              # continue to next location (remove 'continue' and 'exit 1' to fail fast)
              continue
            }

            ipython notebooks/airquality/4_air_quality_batch_inference.ipynb || {
              echo "Batch inference FAILED for $LOCATION_ID (index $IDX)";
              continue
            }

            echo "Completed location: $LOCATION_ID"
            echo ""
          done
        

      - name: github pages publish
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Air Quality Dashboard published"
          commit_options: '--no-verify --signoff'

          file_pattern: 'docs/air-quality/assets/img/* docs/_includes/*'

          repository: .

          status_options: '--untracked-files=no'

          skip_dirty_check: true

          skip_fetch: true

          skip_checkout: true

          push_options: '--force'
